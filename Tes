AWSTemplateFormatVersion: '2010-09-09'
Mappings:
  EnvironmentConfig:
    '123':
      Value: 'test-dev-te'
    '456':
      Value: 'test-tag-te'

Resources:
  MyResource:
    Type: AWS::SomeResource
    Properties:
      SomeProperty: !FindInMap [EnvironmentConfig, !Ref 'AWS::AccountId', Value]


@ECHO OFF
SETLOCAL ENABLEDELAYEDEXPANSION

:MAIN
SET RECODE=0
:: CHECK IF A SERVICE FILE IS PROVIDED AS THE FIRST ARGUMENT

FOR /F "DELIMS=" %%I IN (%~1) DO (
  CALL :SCH %%I
  IF !RECODE! NEQ 0 (
       GOTO :ERR1
  )
)

GOTO :NOR1

:SCH
:: READ THE SERVICE FILE LINE BY LINE AND CHECK EACH SERVICE STATUS, SETTING THE RECODE VALUE

FOR /F "TOKENS=1-4 DELIMS= " %%K IN ('SC QUERY %1 ^| FINDSTR /I "STATE"') DO (
    SET SVCSTID=%%M
)
IF !SVCSTID! EQU 4 (
    SET RECODE=0
    CALL :ECHOTEST "OK"
    EXIT /B !RECODE!
)
IF !SVCSTID! NEQ 4 (
    SET RECODE=8
    CALL :ECHOTEST "FAIL"
    EXIT /B !RECODE!
)

:ECHOTEST
ECHO %1
GOTO :EOF

:ERR1
ECHO "FAIL"

:NOR1
ECHO "OK"

EXIT /B %RECODE%

